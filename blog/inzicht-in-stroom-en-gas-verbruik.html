<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/">
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {

                    colors: {
                        primary: tailwind.colors.blue
                    },
                },},
                }
    </script>


    </head>

<body class="bg-gray-950 font-serif text-gray-200"><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0 "><div class="flex h-screen flex-col justify-between"><header class="flex items-center justify-between py-10"><div><a href><div class="flex items-center justify-between"><div class=" h-6 text-2xl font-semibold sm:block text-primary-800">Bruuteuzius Blogged</div></div></a></div>
    <div class="flex items-center space-x-4 leading-5 sm:space-x-6"><a href="" class="hidden font-medium text-gray-100 sm:block">Home
                </a><a href="tags" class="hidden font-medium text-gray-100 sm:block">Tags
                </a><a href="books" class="hidden font-medium text-gray-100 sm:block">Books
                </a><a href="til" class="hidden font-medium text-gray-100 sm:block">TIL
                </a><a href="https://github.com/bruuteuzius" class="hidden font-medium text-gray-100 sm:block">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="hover:text-primary-400 h-6 w-6 fill-current text-gray-200"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><button id="toggle-button" aria-label="Toggle Menu" class="sm:hidden"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-8 w-8 text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button>
        <div id="mobile-menu" class="fixed left-0 top-0 z-10 h-full w-full translate-x-full transform   duration-300 ease-in-out bg-gray-950 opacity-[0.98]"><div class="flex justify-end"><button id="close-mobile-menu-button" class="mr-8 mt-11 h-8 w-8" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-100"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div>
            <nav class="fixed mt-8 h-full"><div class="px-12 py-4"><a href="" class="text-2xl font-bold tracking-widest text-gray-100">Home
                            </a></div><div class="px-12 py-4"><a href="tags" class="text-2xl font-bold tracking-widest text-gray-100">Tags
                            </a></div><div class="px-12 py-4"><a href="books" class="text-2xl font-bold tracking-widest text-gray-100">Books
                            </a></div><div class="px-12 py-4"><a href="til" class="text-2xl font-bold tracking-widest text-gray-100">TIL
                            </a></div><div class="px-12 py-4"><a href="https://github.com/bruuteuzius" class="text-2xl font-bold tracking-widest text-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="hover:text-primary-400 h-6 w-6 fill-current text-gray-200"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a></div></nav></div></div></header>
<script>
//üëé but what can I do? It's a static html. I can't use C# here.
 const toggleMobileMenu = () => document.querySelector('#mobile-menu').classList.toggle('translate-x-full');
 
 document.querySelector('#toggle-button').addEventListener('click', toggleMobileMenu);
 document.querySelector('#close-mobile-menu-button').addEventListener('click', toggleMobileMenu);
</script>
        <center><img src="imgs/updated_wrong.png" width="80%"></center> 
        
        <main class="mb-auto"><article><div class="xl:divide-y  xl:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt>
                        <dd class="text-base font-medium leading-6 text-gray-400"><time datetime="2021-03-22T00:00:00.000">March 22, 2021</time></dd></div></dl>
                <div class="prose prose-invert mx-auto"><h1 class>Inzicht in stroom en gas verbruik</h1></div></div></header>
        <div class="grid-rows-[auto_1fr] divide-y  pb-8 divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6 xl:divide-y-0"><dl class="pb-10 pt-6 xl:border-b  xl:pt-11 xl:border-gray-700"><dt class="sr-only">Authors</dt>
                <dd><ul class="flex flex-wrap justify-center gap-4 sm:space-x-12 xl:block xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><dl class="whitespace-nowrap text-sm font-medium leading-5"><dt class="sr-only">Name</dt>
                                        <dd class="text-gray-900 dark:text-gray-100 flex gap-1 items-center">bruuteuzius<a target="_blank" rel="noopener noreferrer" href="https://github.com/bruuteuzius" class="flex gap-1 items-center text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="hover:text-primary-400 w-4 h-4 fill-current text-gray-200"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a></dd></dl></li></ul></dd></dl>
            <div class="divide-y  divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="prose prose-invert max-w-none pb-8 pt-10"><p>Natuurlijk kan ik naar de meterkast lopen en het huidig verbruik aflezen maar dat zou te makkelijk zijn. Leuker (en moeilijker) is met een P1 kabel en wat docker en script werk. In een vorige post heb ik verteld over de upgrade naar InfluxDB 2.0 en de uitdagingen die dat met zich meebrengt. Het doel is om het stroom verbruik in een grafana dashboard te kunnen tonen. Aan de hand van onderstaand recept kunnen anderen dat ook voor elkaar krijen.</p>
<h2 id="benodigdheden">Benodigdheden</h2>
<ul>
<li>Een Iskra ME382 slimme meter</li>
<li><a href="https://www.bol.com/nl/p/slimme-meter-kabel-p1-usb/9200000111535827/?s2a=">Deze</a> P1 usb-kabel van Cedel</li>
<li>Een <a href="https://www.raspberrypi.org/">Raspberry PI</a></li>
<li>Een Synology NAS met docker ondersteuning (ik heb een <a href="https://www.synology.com/en-us/products/DS920+">DS920+</a>)</li>
</ul>
<h2 id="voorbereiding">Voorbereiding</h2>
<p>Toevallig had ik al een raspberry pi in de meterkast, waar ik de Unifi-controller op heb <a href="https://www.stevenkussmaul.com/2021/01/27/how-to-install-a-unifi-controller-on-your-raspberry-pi/">ge√Ønstalleerd</a>, zodat ik mijn Ubiquiti AP's kan benaderen/beheren. Sluit de P1 kabel aan op de slimme meter en de usb in de raspberry pi.</p>
<p>Installeer nu ser2net op de pi :</p>
<pre><code>sudo apt update
sudo apt upgrade -y
sudo apt install ser2net -y
</code></pre>
<p>Controleer waar de P1 kabel is aangesloten met : <code>dmesg | grep tty</code></p>
<p>Nu gaan we de ser2net configuratie aanpassen : <code>sudo nano /etc/ser2net.conf</code></p>
<p>Vul de volgende regel in als je ook een Iskra ME382 meter hebt. Anders moet je iets spelen met de baudrate enzo.</p>
<pre><code>6001:raw:600:/dev/ttyUSB0:9600 EVEN 1STOPBIT 7DATABITS XONXOFF LOCAL -RTSCTS
</code></pre>
<p>Als het goed is kun je nu naar het IP adres van je raspberry pi met dat poortnummer en krijg je een stream van misschien onbegrijpelijke data te zien :</p>
<pre><code>/ISk5\2ME382-1003

0-0:96.1.1(4B413650303035313332383430393133)
1-0:1.8.1(11212.230*kWh)
1-0:1.8.2(13588.261*kWh)
1-0:2.8.1(00000.086*kWh)
1-0:2.8.2(00000.728*kWh)
0-0:96.14.0(0001)
1-0:1.7.0(0000.85*kW)
1-0:2.7.0(0000.00*kW)
0-0:17.0.0(0999.00*kW)
0-0:96.3.10(1)
0-0:96.13.1()
0-0:96.13.0()
0-1:24.1.0(3)
0-1:96.1.0(3238303131303031333038353433373133)
0-1:24.3.0(210321190000)(00)(60)(1)(0-1:24.2.1)(m3)
(12168.209)
0-1:24.4.0(1)
!
</code></pre>
<p>Dit blokje data herhaald zich om de 8 seconden met andere waarden in hetzelfde formaat. Als je wil weten wat het precies betekent, is er bijvoorbeeld deze <a href="media/Mx382_User_manual_eng_V1.02_SMS.pdf">handleiding</a> voor de Iskra ME382.</p>
<p>Home Assistant heeft de mogelijkheid dit endpoint uit te lezen. Zo ziet mijn configuratie er uit :</p>
<pre><code>sensor:
  - platform: dsmr
    host: &lt;IP raspbery pi&gt;
    port: 6001
    dsmr_version: 2.2

group:
  meter_readings:
    name: Meter readings
    entities:
      - sensor.energy_consumption_tarif_1
      - sensor.energy_consumption_tarif_2
      - sensor.energy_production_tarif_1
      - sensor.energy_production_tarif_2
      - sensor.gas_consumption
</code></pre>
<p>In Home Assistant verschijnt nu een nieuwe integratie, die van Netbeheer Nederland : DSMR Slimme Meter. Home Assistant heeft standaard een SQLite database. Deze kunnen we niet uitlezen met InfluxDB, dus het plan is om MariaDB te gebruiken. Op de NAS staat deze al geinstalleerd. Maak daar een database en user aan (bijvoorbeeld : hass) en voeg deze configuratie toe aan configuration.yml van Home Assistant :</p>
<pre><code>recorder:
  db_url: mysql://hass:&lt;wachtwoord&gt;@&lt;IP Nas&gt;:3307/homeassistant?charset=utf8
  purge_keep_days: 7
  purge_interval: 1
</code></pre>
<p>Toevallig draait mijn MariaDB op poort 3307 en heet de database homeassistant, maar kan ook wat anders. Herstart Home Assistant en controleer de database of er o.a. de tabellen &quot;states&quot;, &quot;events&quot;, &quot;schema_changes&quot; en &quot;recorder_runs&quot; bestaan.</p>
<h2 id="bereidingswijze">Bereidingswijze</h2>
<p>Men neme nu de InfluxDB 2.0 docker installatie en navigeer naar de Data Explorer.</p>
<p>Hier kun je nu een Flux-query ingeven die de MariaDB database uitleest :</p>
<pre><code>import &quot;sql&quot;

sql.from(
  driverName: &quot;mysql&quot;,
  dataSourceName: &quot;hass:&lt;wachtwoord&gt;@tcp(&lt;IP NAS&gt;:3307)/homeassistant&quot;,
  query: &quot;SELECT state , last_changed FROM `states` WHERE domain = 'sensor' and entity_id = 'sensor.power_consumption' and state &lt;&gt; 'unknown' &quot;
)
|&gt; rename(columns: {&quot;state&quot;: &quot;_value&quot; , &quot;last_changed&quot; : &quot;_time&quot;})
|&gt; toFloat()
|&gt; range(start: v.timeRangeStart, stop:v.timeRangeStop)
|&gt; aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)
|&gt; yield(name: &quot;mean&quot;)
</code></pre>
<p>sql is een plugin die o.a. MS SQL Server, PostgresQL enzovoort kan uitlezen. Het rename attribuut zorgt ervoor dat de karakterreeks in de &quot;state&quot; kolom gelezen kan worden en aangegeven wordt als de waarde in deze timeseries data. De toFloat() functie is nodig om de _value naar een decimaal om te kunnen zetten.</p>
<p>Zodra je voldoende aanpassingen hebt gedaan, kun je een panel toevoegen in je grafana dashboard om je stroomverbruik met behulp van de Flux-query in een grafiek te zetten :</p>
<p><img src="Content/Blog/media/afbeelding-1.png" alt="" /></p>
<p>Nu kan ik nog wat spelen met de Y-as en kleuren en meerdere lijnen bij elkaar (Tarief 1 en tarief 2) enzovoort. Maar het begin is er!</p>
</div>
                <div class="pb-6 pt-6 text-sm text-gray-300"><a target="_blank" rel="noopener noreferrer" href="https://github.com/bruuteuzius/tree/main/Content/Blog/inzicht-in-stroom-en-gas-verbruik">View on GitHub</a></div></div>
            <footer><div class=" text-sm font-medium leading-5 divide-gray-700 xl:col-start-1 xl:row-start-2 xl:divide-y"><div class="py-4 xl:py-8"><h2 class="text-xs uppercase tracking-wide text-gray-400">Tags</h2>
                        <div class="flex flex-wrap"><a class="text-primary-500 hover:text-primary-400 mr-3 text-sm font-medium uppercase" href="tags/homelab">homelab</a></div></div></div>
                <div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-400" aria-label="Back to the home" href>‚Üê Back to the home</a></div></footer></div></div></article></main>

        <footer><div class="mt-16 flex flex-col items-center"><div class="mb-3 flex space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/bruuteuzius"><span class="sr-only">github</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="hover:text-primary-400 h-6 w-6 fill-current text-gray-200"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a></div>
                <div class="mb-2 flex space-x-2 text-sm text-gray-400"><a target="_blank" rel="noopener noreferrer" href="https://github.com/BlazorStatic/BlazorStatic"> Built with Blazor Static</a>
                    <div>‚Ä¢</div>
                    <div>¬© 2025</div></div></div></footer></div></div>
        <blazor-focus-on-navigate selector="h1"></blazor-focus-on-navigate></body></html>